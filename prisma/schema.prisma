generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── ENUMS ───────────────────────────────────────────────

enum ArticleCategory {
  HIGH_TIER   // Teure Artikel MIT Seriennummer, IMMER nachbestellen
  MID_TIER    // Artikel OHNE Seriennummer, nachbestellen pro Auftrag
  LOW_TIER    // Schüttgut (Kabel etc.), muss bei Aufträgen NICHT nachbestellt werden
}

enum StockMovementType {
  IN         // Wareneingang
  OUT        // Warenausgang
  ADJUSTMENT // Inventurkorrektur
}

enum SerialNumberStatus {
  IN_STOCK   // Verfügbar im Lager
  RESERVED   // Reserviert für Auftrag
  DEPLOYED   // Ausgeliefert an Endbenutzer
  DEFECTIVE  // Defekt
  RETURNED   // Rückläufer
  DISPOSED   // Entsorgt
}

enum OrderStatus {
  NEW              // Neu angelegt
  IN_COMMISSION    // Kommissionierung läuft
  IN_SETUP         // Einrichtung läuft
  READY_TO_SHIP    // Versandbereit
  SHIPPED          // Versendet/Abgeholt
  COMPLETED        // Abgeschlossen (inkl. Beschaffung + Wareneingang)
  CANCELLED        // Storniert
}

enum DeliveryMethod {
  SHIPPING // Versand an Adresse
  PICKUP   // Abholung vor Ort
}

enum MobilfunkType {
  PHONE_AND_SIM // Handy + SIM
  PHONE_ONLY    // Nur Handy
  SIM_ONLY      // Nur SIM
}

enum SimType {
  SIM  // Physische SIM-Karte
  ESIM // eSIM
}

enum MobilfunkTariff {
  STANDARD  // Normaler Tarif
  UNLIMITED // Unbegrenzt-Tarif
}

// ─── ARTIKEL ─────────────────────────────────────────────

model Article {
  id               String          @id @default(cuid())
  name             String
  description      String?
  sku              String          @unique
  category         ArticleCategory
  productGroup     String?         // z.B. "Notebook", "Monitor", "Drucker"
  productSubGroup  String?         // z.B. "14 Zoll", "27 Zoll", "Tintenstrahl"
  avgPurchasePrice Decimal?        @db.Decimal(10, 2) // Durchschnittlicher Einkaufspreis ohne MwSt.
  unit             String          @default("Stk")
  minStockLevel    Int             @default(0)
  currentStock     Int             @default(0)
  incomingStock    Int             @default(0) // Im Zulauf (durch Bestellungen getriggert)
  imageUrl         String?
  isActive         Boolean         @default(true)
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serialNumbers    SerialNumber[]
  stockMovements   StockMovement[]
  articleSuppliers ArticleSupplier[]
  stockLocations   StockLocation[]
  orderItems       OrderItem[]

  @@index([category])
  @@index([name])
}

// ─── SERIENNUMMERN ───────────────────────────────────────

model SerialNumber {
  id          String             @id @default(cuid())
  serialNo    String             @unique
  articleId   String
  status      SerialNumberStatus @default(IN_STOCK)
  isUsed      Boolean            @default(false) // Gebraucht = wird NICHT nachbestellt
  notes       String?
  orderItemId String?            // Verknüpfung zur Auftragsposition (bei Entnahme)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article    Article            @relation(fields: [articleId], references: [id], onDelete: Cascade)
  location   WarehouseLocation? @relation(fields: [locationId], references: [id])
  locationId String?
  orderItem  OrderItem?         @relation(fields: [orderItemId], references: [id])

  @@index([articleId])
  @@index([status])
}

// ─── LAGERORTE ───────────────────────────────────────────

model WarehouseLocation {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serialNumbers  SerialNumber[]
  stockLocations StockLocation[]
}

// ─── LAGERBESTAND PRO ORT ────────────────────────────────

model StockLocation {
  id         String @id @default(cuid())
  articleId  String
  locationId String
  quantity   Int    @default(0)

  article  Article           @relation(fields: [articleId], references: [id], onDelete: Cascade)
  location WarehouseLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([articleId, locationId])
}

// ─── LAGERBEWEGUNGEN (AUDIT LOG) ─────────────────────────

model StockMovement {
  id          String            @id @default(cuid())
  articleId   String
  type        StockMovementType
  quantity    Int
  reason      String?
  performedBy String?
  orderId     String?           // Verknüpfung zum Auftrag (für Audit-Trail)
  orderItemId String?           // Verknüpfung zur Position

  createdAt DateTime @default(now())

  article   Article    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  order     Order?     @relation(fields: [orderId], references: [id])
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id])

  @@index([articleId])
  @@index([type])
  @@index([createdAt])
}

// ─── LIEFERANTEN ─────────────────────────────────────────

model Supplier {
  id          String  @id @default(cuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  website     String?
  notes       String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articleSuppliers ArticleSupplier[]
  orderItems       OrderItem[]
}

// ─── ARTIKEL-LIEFERANTEN ZUORDNUNG ───────────────────────

model ArticleSupplier {
  id            String   @id @default(cuid())
  articleId     String
  supplierId    String
  supplierSku   String?
  unitPrice     Decimal  @db.Decimal(10, 2)
  currency      String   @default("EUR")
  leadTimeDays  Int?
  minOrderQty   Int      @default(1)
  isPreferred   Boolean  @default(false)
  lastOrderDate DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article  Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([articleId, supplierId])
  @@index([articleId])
  @@index([supplierId])
}

// ─── AUFTRÄGE ───────────────────────────────────────────

model Order {
  id              String         @id @default(cuid())
  orderNumber     String         @unique  // BES-001, BES-002, ...
  status          OrderStatus    @default(NEW)
  orderedBy       String         // Wer hat bestellt (Name)
  orderedFor      String         // Für wen ist die Bestellung (Name)
  costCenter      String         // Kostenstelle (Nummer)
  deliveryMethod  DeliveryMethod
  shippingCompany String?        // Firmenname (nur bei SHIPPING)
  shippingStreet  String?        // Straße + Hausnr (nur bei SHIPPING)
  shippingZip     String?        // PLZ (nur bei SHIPPING)
  shippingCity    String?        // Stadt (nur bei SHIPPING)
  pickupBy        String?        // Nur bei PICKUP: wer holt ab
  notes           String?
  trackingNumber  String?        // Sendungsnummer
  shippedAt       DateTime?      // Versanddatum
  shippedBy       String?        // Techniker der versendet hat
  technicianName  String?        // Name des zugewiesenen Technikers
  techDoneAt      DateTime?      // Techniker-Arbeit abgeschlossen
  procDoneAt      DateTime?      // Beschaffung abgeschlossen
  commissionedAt  DateTime?      // Alle Artikel kommissioniert
  commissionedBy  String?        // Wer hat kommissioniert
  setupDoneAt     DateTime?      // Einrichtung abgeschlossen
  setupDoneBy     String?        // Wer hat eingerichtet

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items          OrderItem[]
  mobilfunk      OrderMobilfunk[]
  stockMovements StockMovement[]

  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id              String    @id @default(cuid())
  orderId         String
  articleId       String?   // Null wenn Freitext-Position
  freeText        String?   // Freitext-Beschreibung (z.B. von externen Tools)
  quantity        Int
  // Techniker-Stream
  pickedQty       Int       @default(0)    // Entnommene Menge
  serialNumberId  String?                  // Gewählte SN (nur SERIALIZED)
  pickedBy        String?                  // Wer hat entnommen
  pickedAt        DateTime?                // Wann entnommen
  // Bestell-Stream
  needsOrdering   Boolean   @default(false) // Muss nachbestellt werden (auto-berechnet)
  supplierId      String?                   // Lieferant für Nachbestellung
  supplierOrderNo String?                   // Bestellnummer beim Lieferanten
  orderedAt       DateTime?                 // Wann bestellt
  orderedBy       String?                   // Wer hat bestellt
  // Wareneingang-Stream
  receivedQty     Int       @default(0)    // Empfangene Menge
  receivedAt      DateTime?                // Wann empfangen

  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  article        Article?       @relation(fields: [articleId], references: [id])
  supplier       Supplier?      @relation(fields: [supplierId], references: [id])
  serialNumbers  SerialNumber[]
  stockMovements StockMovement[]

  @@index([orderId])
}

// ─── MOBILFUNK (Tracking in Aufträgen) ─────────────────

model OrderMobilfunk {
  id              String           @id @default(cuid())
  orderId         String
  type            MobilfunkType    // Handy+SIM, nur Handy, nur SIM
  simType         SimType?         // SIM oder eSIM (nur wenn SIM dabei)
  tariff          MobilfunkTariff? // Tarif (nur wenn SIM dabei)
  phoneNote       String?          // z.B. Modellwunsch, Farbe etc.
  simNote         String?          // z.B. Rufnummer, Portierung etc.
  delivered       Boolean          @default(false) // Bei Lieferung abgehakt
  // Techniker-Setup
  imei            String?          // IMEI-Nummer (bei PHONE_AND_SIM / PHONE_ONLY)
  phoneNumber     String?          // Handynummer (bei PHONE_AND_SIM / SIM_ONLY)
  setupDone       Boolean          @default(false) // Einrichtung abgeschlossen
  setupBy         String?          // Wer hat eingerichtet
  setupAt         DateTime?        // Wann eingerichtet
  // Bestell-Stream
  ordered         Boolean          @default(false) // Beim Provider bestellt
  orderedBy       String?          // Wer hat bestellt
  orderedAt       DateTime?        // Wann bestellt
  providerOrderNo String?          // Bestellnummer beim Provider
  // Wareneingang-Stream
  received        Boolean          @default(false) // Ware empfangen
  receivedAt      DateTime?        // Wann empfangen

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}
