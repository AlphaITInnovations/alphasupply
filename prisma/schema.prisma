generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── ENUMS ───────────────────────────────────────────────

enum ArticleCategory {
  SERIALIZED  // Teure Artikel MIT Seriennummer, IMMER nachbestellen
  STANDARD    // Artikel OHNE Seriennummer, nachbestellen pro Auftrag
  CONSUMABLE  // Schüttgut (Kabel etc.), muss bei Aufträgen NICHT nachbestellt werden
}

enum StockMovementType {
  IN         // Wareneingang
  OUT        // Warenausgang
  ADJUSTMENT // Inventurkorrektur
}

enum SerialNumberStatus {
  IN_STOCK   // Verfügbar im Lager
  RESERVED   // Reserviert für Auftrag
  DEPLOYED   // Ausgeliefert an Endbenutzer
  DEFECTIVE  // Defekt
  RETURNED   // Rückläufer
  DISPOSED   // Entsorgt
}

enum OrderStatus {
  NEW          // Neu angelegt, noch nicht bearbeitet
  IN_PROGRESS  // In Bearbeitung (Zusammenstellung/Einrichtung)
  READY        // Bereit zur Abholung/Versand
  COMPLETED    // Abgeschlossen
  CANCELLED    // Storniert
}

enum DeliveryMethod {
  SHIPPING // Versand an Adresse
  PICKUP   // Abholung vor Ort
}

// ─── ARTIKEL ─────────────────────────────────────────────

model Article {
  id               String          @id @default(cuid())
  name             String
  description      String?
  sku              String          @unique
  category         ArticleCategory
  productGroup     String?         // z.B. "Notebook", "Monitor", "Drucker"
  productSubGroup  String?         // z.B. "14 Zoll", "27 Zoll", "Tintenstrahl"
  avgPurchasePrice Decimal?        @db.Decimal(10, 2) // Durchschnittlicher Einkaufspreis ohne MwSt.
  unit             String          @default("Stk")
  minStockLevel    Int             @default(0)
  currentStock     Int             @default(0)
  imageUrl         String?
  isActive         Boolean         @default(true)
  notes            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serialNumbers    SerialNumber[]
  stockMovements   StockMovement[]
  articleSuppliers ArticleSupplier[]
  stockLocations   StockLocation[]
  orderItems       OrderItem[]

  @@index([category])
  @@index([name])
}

// ─── SERIENNUMMERN ───────────────────────────────────────

model SerialNumber {
  id         String             @id @default(cuid())
  serialNo   String             @unique
  articleId  String
  status     SerialNumberStatus @default(IN_STOCK)
  isUsed     Boolean            @default(false) // Gebraucht = wird NICHT nachbestellt
  notes      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article  Article            @relation(fields: [articleId], references: [id], onDelete: Cascade)
  location WarehouseLocation? @relation(fields: [locationId], references: [id])
  locationId String?

  @@index([articleId])
  @@index([status])
}

// ─── LAGERORTE ───────────────────────────────────────────

model WarehouseLocation {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  serialNumbers  SerialNumber[]
  stockLocations StockLocation[]
}

// ─── LAGERBESTAND PRO ORT ────────────────────────────────

model StockLocation {
  id         String @id @default(cuid())
  articleId  String
  locationId String
  quantity   Int    @default(0)

  article  Article           @relation(fields: [articleId], references: [id], onDelete: Cascade)
  location WarehouseLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([articleId, locationId])
}

// ─── LAGERBEWEGUNGEN (AUDIT LOG) ─────────────────────────

model StockMovement {
  id          String            @id @default(cuid())
  articleId   String
  type        StockMovementType
  quantity    Int
  reason      String?
  performedBy String?

  createdAt DateTime @default(now())

  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
  @@index([type])
  @@index([createdAt])
}

// ─── LIEFERANTEN ─────────────────────────────────────────

model Supplier {
  id          String  @id @default(cuid())
  name        String
  contactName String?
  email       String?
  phone       String?
  website     String?
  notes       String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articleSuppliers ArticleSupplier[]
}

// ─── ARTIKEL-LIEFERANTEN ZUORDNUNG ───────────────────────

model ArticleSupplier {
  id            String   @id @default(cuid())
  articleId     String
  supplierId    String
  supplierSku   String?
  unitPrice     Decimal  @db.Decimal(10, 2)
  currency      String   @default("EUR")
  leadTimeDays  Int?
  minOrderQty   Int      @default(1)
  isPreferred   Boolean  @default(false)
  lastOrderDate DateTime?
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  article  Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([articleId, supplierId])
  @@index([articleId])
  @@index([supplierId])
}

// ─── AUFTRÄGE ───────────────────────────────────────────

model Order {
  id              String         @id @default(cuid())
  orderNumber     String         @unique  // BES-001, BES-002, ...
  status          OrderStatus    @default(NEW)
  orderedBy       String         // Wer hat bestellt (Name)
  orderedFor      String         // Für wen ist die Bestellung (Name)
  costCenter      String         // Kostenstelle (Nummer)
  deliveryMethod  DeliveryMethod
  shippingAddress String?        // Nur bei SHIPPING
  pickupBy        String?        // Nur bei PICKUP: wer holt ab
  notes           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  articleId String
  quantity  Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  article Article @relation(fields: [articleId], references: [id])

  @@unique([orderId, articleId])
  @@index([orderId])
}
